#!/bin/bash
set -e

# Swift Android Build Script
# This script builds the Swift library for Android architectures
# Includes swift-java support for calling Java libraries from Swift
#
# Usage: ./build-swift.sh [--release] [--all-archs]
#   --release     Build in release mode (default: debug)
#   --all-archs   Build for all architectures including arm64 (default: x86_64 only)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
SWIFT_LIB_DIR="$PROJECT_ROOT/swift-library"
OUTPUT_DIR="$PROJECT_ROOT/app/src/main/jniLibs"

# Build configuration (debug by default, use --release for release)
BUILD_CONFIG="debug"
BUILD_ALL_ARCHS=false

for arg in "$@"; do
    case $arg in
        --release|-r)
            BUILD_CONFIG="release"
            ;;
        --all-archs|-a)
            BUILD_ALL_ARCHS=true
            ;;
    esac
done

# Android architectures to build for
# By default, only x86_64 (emulators) for faster development
# Use --all-archs to include arm64-v8a (real devices)
if [ "$BUILD_ALL_ARCHS" = true ]; then
    ARCHS=("aarch64-unknown-linux-android28" "x86_64-unknown-linux-android28")
    ABI_DIRS=("arm64-v8a" "x86_64")
    echo "üî® Building Swift library for Android ($BUILD_CONFIG) - ALL ARCHITECTURES..."
else
    ARCHS=("x86_64-unknown-linux-android28")
    ABI_DIRS=("x86_64")
    echo "üî® Building Swift library for Android ($BUILD_CONFIG) - x86_64 only (use --all-archs for arm64)..."
fi
echo "   Swift library: $SWIFT_LIB_DIR"
echo "   Output: $OUTPUT_DIR"

# Check if swift is available
if ! command -v swift &> /dev/null; then
    echo "‚ùå Swift not found. Please install Swift toolchain."
    exit 1
fi

# Check if Android SDK is installed
if ! swift sdk list 2>/dev/null | grep -q "android"; then
    echo "‚ö†Ô∏è  Swift SDK for Android not found."
    echo "   Install it with:"
    echo "   swift sdk install <android-sdk-url>"
    echo ""
    echo "   See: https://www.swift.org/documentation/articles/swift-sdk-for-android-getting-started.html"
    exit 1
fi

cd "$SWIFT_LIB_DIR"

# Set SWIFT_ANDROID_HOME to trigger Android mode in CPython Package.swift
export SWIFT_ANDROID_HOME=1

# Find Android NDK and set up sysroot for C headers (jni.h, assert.h, etc.)
ANDROID_SDK_ROOT="${ANDROID_HOME:-$HOME/Library/Android/sdk}"
NDK_VERSION=$(ls "$ANDROID_SDK_ROOT/ndk" 2>/dev/null | sort -V | tail -1)
if [ -z "$NDK_VERSION" ]; then
    echo "‚ùå Android NDK not found in $ANDROID_SDK_ROOT/ndk"
    exit 1
fi
ANDROID_NDK_ROOT="$ANDROID_SDK_ROOT/ndk/$NDK_VERSION"
NDK_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/darwin-x86_64/sysroot"
NDK_INCLUDE="$NDK_SYSROOT/usr/include"

# Find clang resource directory for compiler-provided headers (stddef.h, etc.)
NDK_CLANG_VERSION=$(ls "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/darwin-x86_64/lib/clang" | head -1)
NDK_CLANG_INCLUDE="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/darwin-x86_64/lib/clang/$NDK_CLANG_VERSION/include"

echo "   Using Android NDK: $ANDROID_NDK_ROOT"
echo "   Using Clang includes: $NDK_CLANG_INCLUDE"

# First, build the host tools (swift-java) needed by plugins
# This is required because swift-java plugins need host-platform tools
# We build directly in swift-java, not in swift-library to avoid CPython Android-only dependencies
echo ""
echo "üîß Building host tools for plugins..."
SWIFT_JAVA_DIR="/Volumes/CodeSSD/GitHub/swift-java"
(cd "$SWIFT_JAVA_DIR" && swift build --disable-sandbox -c "$BUILD_CONFIG" --product swift-java)

# Copy swift-java tool to where the plugin expects it (as SwiftJavaTool)
mkdir -p "$SWIFT_LIB_DIR/.build/x86_64-apple-macosx/$BUILD_CONFIG"
cp "$SWIFT_JAVA_DIR/.build/$BUILD_CONFIG/swift-java" "$SWIFT_LIB_DIR/.build/x86_64-apple-macosx/$BUILD_CONFIG/SwiftJavaTool" 2>/dev/null || true

for i in "${!ARCHS[@]}"; do
    ARCH="${ARCHS[$i]}"
    ABI="${ABI_DIRS[$i]}"
    
    echo ""
    echo "üì¶ Building for $ARCH ($ABI) [$BUILD_CONFIG]..."
    
    # Path to libpython3.13.so for linking
    PYTHON_LIB_DIR="$OUTPUT_DIR/$ABI"
    
    # Determine architecture-specific include path for asm headers
    if [[ "$ARCH" == *"aarch64"* ]] || [[ "$ARCH" == *"arm64"* ]]; then
        NDK_ARCH_INCLUDE="$NDK_INCLUDE/aarch64-linux-android"
    else
        NDK_ARCH_INCLUDE="$NDK_INCLUDE/x86_64-linux-android"
    fi
    
    # Build the Swift library (includes swift-java dependency)
    # --disable-sandbox is required for SwiftJavaPlugin to fetch Java dependencies
    # -Xlinker -L adds library search path for libpython3.13.so
    # -Xcc -isystem adds NDK sysroot for C headers (jni.h, assert.h, asm/types.h, stddef.h, etc.)
    swift build \
        --swift-sdk "$ARCH" \
        --disable-sandbox \
        -c "$BUILD_CONFIG" \
        -Xcc -isystem -Xcc "$NDK_CLANG_INCLUDE" \
        -Xcc -isystem -Xcc "$NDK_INCLUDE" \
        -Xcc -isystem -Xcc "$NDK_ARCH_INCLUDE" \
        -Xlinker -L"$PYTHON_LIB_DIR"
    
    # Create output directory
    mkdir -p "$OUTPUT_DIR/$ABI"
    
    # Find the build directory - try architecture-specific first
    BUILD_DIR="$SWIFT_LIB_DIR/.build/$ARCH/$BUILD_CONFIG"
    if [ ! -d "$BUILD_DIR" ]; then
        BUILD_DIR="$SWIFT_LIB_DIR/.build/$BUILD_CONFIG"
    fi
    
    echo "   üìÅ Build directory: $BUILD_DIR"
    
    # Copy libSwiftAndroidLib.so (our main library)
    if [ -f "$BUILD_DIR/libSwiftAndroidLib.so" ]; then
        cp "$BUILD_DIR/libSwiftAndroidLib.so" "$OUTPUT_DIR/$ABI/"
        echo "   ‚úÖ Copied libSwiftAndroidLib.so"
    else
        echo "   ‚ùå Could not find libSwiftAndroidLib.so in $BUILD_DIR"
        ls -la "$BUILD_DIR"/*.so 2>/dev/null || echo "   No .so files found"
        exit 1
    fi
    
    # Copy libSwiftJava.so (swift-java runtime for JNI interop)
    if [ -f "$BUILD_DIR/libSwiftJava.so" ]; then
        cp "$BUILD_DIR/libSwiftJava.so" "$OUTPUT_DIR/$ABI/"
        echo "   ‚úÖ Copied libSwiftJava.so (swift-java runtime)"
    else
        echo "   ‚ö†Ô∏è  libSwiftJava.so not found (may not be needed if not using swift-java)"
    fi
    
    # Copy any other built libraries (like JavaCSV wrapper if built separately)
    for lib in "$BUILD_DIR"/lib*.so; do
        if [ -f "$lib" ]; then
            LIB_NAME=$(basename "$lib")
            if [ "$LIB_NAME" != "libSwiftAndroidLib.so" ] && [ "$LIB_NAME" != "libSwiftJava.so" ]; then
                cp "$lib" "$OUTPUT_DIR/$ABI/"
                echo "   ‚úÖ Copied $LIB_NAME"
            fi
        fi
    done
done

echo ""
echo "‚úÖ Swift library build complete!"
echo ""
echo "üìÅ Output structure:"
find "$OUTPUT_DIR" -name "*.so" -exec ls -lh {} \;

echo ""
echo "üìù Next steps:"
echo "   1. Run: ./scripts/copy-swift-runtime.sh"
echo "   2. Build the Android app: ./gradlew assembleDebug"
echo "   3. Install on device: adb install -r app/build/outputs/apk/debug/app-debug.apk"
